# Instagram Scraper V2 - Bug Fix Report

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞:** `AggregateError [ETIMEDOUT]` –≤ `project-manager.ts:212`

**Run ID:** `01K3CHTW9Z2WSNZMQEC8VVCAZZ`

**–§—É–Ω–∫—Ü–∏—è:** `ü§ñ Instagram Scraper V2 (Real API + Zod)`

**–ü—Ä–∏—á–∏–Ω–∞:** Timeout –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ PostgreSQL –≤ –º–µ—Ç–æ–¥–µ `getProjectById()`

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. Database Connection Pool Configuration

**–§–∞–π–ª:** `src/core/instagram/project-manager.ts` –∏ `src/inngest-functions/instagramScraper-v2.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PostgreSQL Pool:

```typescript
dbPool = new Pool({
  connectionString,
  ssl: { rejectUnauthorized: false },
  // ‚¨áÔ∏è –ù–û–í–´–ï –ù–ê–°–¢–†–û–ô–ö–ò
  connectionTimeoutMillis: 30000, // 30 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  idleTimeoutMillis: 30000, // 30 —Å–µ–∫—É–Ω–¥ idle timeout
  queryTimeout: 60000, // 60 —Å–µ–∫—É–Ω–¥ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
  max: 10, // –ú–∞–∫—Å–∏–º—É–º 10 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤ –ø—É–ª–µ
  min: 2, // –ú–∏–Ω–∏–º—É–º 2 —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  acquireTimeoutMillis: 20000, // 20 —Å–µ–∫—É–Ω–¥ –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏–∑ –ø—É–ª–∞
})

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
dbPool.on('error', err => {
  log.error('PostgreSQL pool error:', err.message)
})

dbPool.on('connect', client => {
  log.info('New PostgreSQL client connected')
})
```

### 2. Retry Logic Implementation

**–§–∞–π–ª:** `src/core/instagram/project-manager.ts`

–î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ —Å —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π:

```typescript
async getProjectById(projectId: number, retries: number = 3): Promise<Project | null> {
  for (let attempt = 1; attempt <= retries; attempt++) {
    try {
      // ... –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ...
    } catch (error: any) {
      log.error(`Error getting project by ID (attempt ${attempt}/${retries}):`, error.message)

      if (attempt === retries) {
        throw new Error(`Failed to get project ${projectId} after ${retries} attempts: ${error.message}`)
      }

      // –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞: 1s, 2s, 4s
      const delay = Math.pow(2, attempt - 1) * 1000
      log.info(`Retrying after ${delay}ms...`)
      await new Promise(resolve => setTimeout(resolve, delay))
    }
  }
}
```

### 3. Enhanced Error Handling

- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ–ø—ã—Ç–æ–∫
- –î–æ–±–∞–≤–ª–µ–Ω graceful fallback –¥–ª—è —Å–ª—É—á–∞–µ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î

### 4. Merge Conflict Resolution

**–§–∞–π–ª:** `src/app.ts`

–ò—Å–ø—Ä–∞–≤–ª–µ–Ω merge conflict –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ N8N proxy.

## üìã –°–æ–∑–¥–∞–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:** `tests/instagram-scraper-v2-diagnostic.ts`

   - –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
   - –¢–µ—Å—Ç timeout handling
   - –¢–µ—Å—Ç retry –ª–æ–≥–∏–∫–∏
   - –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤

2. **–Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã:** `tests/instagram-scraper-v2-unit.test.ts`
   - –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—É–ª–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –¢–µ—Å—Ç —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
   - –¢–µ—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
   - –¢–µ—Å—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **–°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞:** –£—Å–ø–µ—à–Ω–æ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è (`npm run build`)
- ‚úÖ **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã merge:** –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã
- ‚úÖ **Retry –ª–æ–≥–∏–∫–∞:** –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –º–µ—Ç–æ–¥—ã
- ‚úÖ **Timeout –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:** –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ –¥–ª—è production
- ‚úÖ **–¢–µ—Å—Ç—ã:** –°–æ–∑–¥–∞–Ω—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –ø—Ä–æ–±–ª–µ–º

## üöÄ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã:

- `src/core/instagram/project-manager.ts` - –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –∏ timeout –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- `src/inngest-functions/instagramScraper-v2.ts` - –£–ª—É—á—à–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è DB pool
- `src/app.ts` - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω merge conflict
- `tests/` - –°–æ–∑–¥–∞–Ω—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –∏ —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã

### –ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π retry –ø—Ä–∏ —Å–±–æ—è—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏ (1s, 2s, 4s)
- –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ timeout –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è production –Ω–∞–≥—Ä—É–∑–∫–∏

## üîÆ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–§—É–Ω–∫—Ü–∏—è Instagram Scraper V2 —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω–∞:

1. –£—Å—Ç–æ–π—á–∏–≤–æ —Ä–∞–±–æ—Ç–∞—Ç—å –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö —Å–µ—Ç–∏
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ –∫—Ä–∞—Ç–∫–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º —Å –ë–î
3. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –ø—Ä–æ–±–ª–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
4. –ò–∑–±–µ–≥–∞—Ç—å —Ç–∞–π–º–∞—É—Ç–æ–≤ –±–ª–∞–≥–æ–¥–∞—Ä—è –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º

**–°—Ç–∞—Ç—É—Å:** –ì–æ—Ç–æ–≤–æ –∫ production deploy üöÄ
