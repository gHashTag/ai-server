#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะทะฐะฟััะบะฐ ะธะฝัะตะณัะฐัะธะพะฝะฝะพะณะพ ัะตััะฐ Instagram Scraper
# ะะฒัะพะผะฐัะธัะตัะบะธ ะฟัะพะฒะตััะตั ะทะฐะฒะธัะธะผะพััะธ ะธ ะทะฐะฟััะบะฐะตั ัะตัั

set -e

echo "๐ ะะฐะฟััะบ ะธะฝัะตะณัะฐัะธะพะฝะฝะพะณะพ ัะตััะฐ Instagram Scraper"
echo "=================================================="

# ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
echo "๐ ะัะพะฒะตัะบะฐ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั..."

if [ -z "$SUPABASE_URL" ]; then
    echo "โ SUPABASE_URL ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ"
    exit 1
fi

if [ -z "$RAPIDAPI_INSTAGRAM_KEY" ]; then
    echo "โ RAPIDAPI_INSTAGRAM_KEY ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ"
    exit 1
fi

if [ -z "$RAPIDAPI_INSTAGRAM_HOST" ]; then
    echo "โ RAPIDAPI_INSTAGRAM_HOST ะฝะต ัััะฐะฝะพะฒะปะตะฝะฐ"
    exit 1
fi

echo "โ ะะตัะตะผะตะฝะฝัะต ะพะบััะถะตะฝะธั ะฝะฐัััะพะตะฝั"

# ะัะพะฒะตัะบะฐ, ััะพ ะฟะพัั 8288 ัะฒะพะฑะพะดะตะฝ
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพััะฐ 8288..."
if lsof -i :8288 >/dev/null 2>&1; then
    echo "โ๏ธ ะะพัั 8288 ะทะฐะฝัั, ะฟะพะฟััะบะฐ ะพัะฒะพะฑะพะดะธัั..."
    # ะฃะฑะธะฒะฐะตะผ ะฟัะพัะตััั ะฝะฐ ะฟะพััั 8288
    lsof -ti :8288 | xargs -r kill -9
    sleep 2
    
    if lsof -i :8288 >/dev/null 2>&1; then
        echo "โ ะะต ัะดะฐะปะพัั ะพัะฒะพะฑะพะดะธัั ะฟะพัั 8288"
        exit 1
    fi
fi

echo "โ ะะพัั 8288 ัะฒะพะฑะพะดะตะฝ"

# ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ ะัะพะฒะตัะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."

if ! command -v node >/dev/null 2>&1; then
    echo "โ Node.js ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

if ! command -v npx >/dev/null 2>&1; then
    echo "โ npx ะฝะต ัััะฐะฝะพะฒะปะตะฝ"
    exit 1
fi

# ะัะพะฒะตัะบะฐ inngest-cli
if ! npm list -g inngest-cli >/dev/null 2>&1; then
    echo "โ๏ธ inngest-cli ะฝะต ัััะฐะฝะพะฒะปะตะฝ ะณะปะพะฑะฐะปัะฝะพ, ะฟัะพะฑัะตะผ ัััะฐะฝะพะฒะธัั..."
    npm install -g inngest-cli
fi

echo "โ ะะฐะฒะธัะธะผะพััะธ ะฟัะพะฒะตัะตะฝั"

# ะัะพะฒะตัะบะฐ TypeScript ะบะพะผะฟะธะปััะธะธ
echo "๐ ะัะพะฒะตัะบะฐ TypeScript..."
if ! npx tsc --noEmit; then
    echo "โ ะัะธะฑะบะธ TypeScript, ะธัะฟัะฐะฒััะต ะธั ะฟะตัะตะด ะทะฐะฟััะบะพะผ ัะตััะฐ"
    exit 1
fi

echo "โ TypeScript ะฟัะพะฒะตัะตะฝ"

# ะกะพะทะดะฐะฝะธะต ัะตะทะตัะฒะฝะพะน ะบะพะฟะธะธ ะปะพะณะฐ
LOG_FILE="integration-test-$(date +%Y%m%d_%H%M%S).log"
echo "๐ ะะพะณ ะฑัะดะตั ัะพััะฐะฝะตะฝ ะฒ: $LOG_FILE"

# ะะฐะฟััะบ ัะตััะฐ
echo ""
echo "๐ ะะฐะฟััะบ ะธะฝัะตะณัะฐัะธะพะฝะฝะพะณะพ ัะตััะฐ..."
echo "=================================================="

# ะะฐะฟััะบะฐะตะผ ัะตัั ั ะปะพะณะธัะพะฒะฐะฝะธะตะผ
if npx tsx test-events/inngest-integration-test.ts 2>&1 | tee "$LOG_FILE"; then
    echo ""
    echo "๐ ะะะขะะะะะฆะะะะะซะ ะขะะกะข ะะะะะะจะะ ะฃะกะะะจะะ!"
    echo "๐ ะะพะณ ัะพััะฐะฝะตะฝ ะฒ: $LOG_FILE"
    exit 0
else
    echo ""
    echo "โ ะะะขะะะะะฆะะะะะซะ ะขะะกะข ะะะะะะะะ"
    echo "๐ ะะพะณ ัะพััะฐะฝะตะฝ ะฒ: $LOG_FILE"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณ ะดะปั ะดะธะฐะณะฝะพััะธะบะธ ะฟัะพะฑะปะตะผ"
    exit 1
fi 