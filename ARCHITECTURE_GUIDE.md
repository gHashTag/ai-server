# AI Server Architecture Guide - –ü–ª–∞–Ω –ê –∏ –ü–ª–∞–Ω –ë

## –û–±–∑–æ—Ä

–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –≤–µ—Ç–∫–∏ v2 —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–∏—Å—Ç–µ–º—É —Å –¥–≤—É–º—è –ø–ª–∞–Ω–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
- **–ü–ª–∞–Ω –ê (Inngest)** - –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏ —Å–æ–±—ã—Ç–∏–π —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫
- **–ü–ª–∞–Ω –ë (Fallback)** - –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å—é –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–ª—É—á–∞–µ–≤

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
src/
‚îú‚îÄ‚îÄ inngest/                    # –ü–ª–∞–Ω –ê - Inngest —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îú‚îÄ‚îÄ client.ts              # Inngest –∫–ª–∏–µ–Ω—Ç
‚îÇ   ‚îú‚îÄ‚îÄ functions/             # –§—É–Ω–∫—Ü–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generateImage.ts   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generateVideo.ts   # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ generateSpeech.ts  # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—á–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ index.ts              # –ì–ª–∞–≤–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îú‚îÄ‚îÄ fallback/              # –ü–ª–∞–Ω –ë - Fallback —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ imageGeneration.ts # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ videoGeneration.ts # –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ speechGeneration.ts# –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—á–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # –≠–∫—Å–ø–æ—Ä—Ç fallback —Ñ—É–Ω–∫—Ü–∏–π
‚îÇ   ‚îî‚îÄ‚îÄ [—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã]
‚îú‚îÄ‚îÄ controllers/
‚îÇ   ‚îî‚îÄ‚îÄ generation.controller.ts # –í—ã–±–æ—Ä –ø–ª–∞–Ω–∞ –ê/–ë
‚îî‚îÄ‚îÄ config/
    ‚îî‚îÄ‚îÄ index.ts              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
USE_INNGEST=true          # false - –æ—Ç–∫–ª—é—á–∞–µ—Ç –ø–ª–∞–Ω –ê
FALLBACK_MODE=false       # true - –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø–ª–∞–Ω –ë

# Inngest –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
INNGEST_EVENT_KEY=your_event_key
INNGEST_SIGNING_KEY=your_signing_key
```

### –õ–æ–≥–∏–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

```typescript
// –í config/index.ts
export function shouldUseInngest(): boolean {
  return EXECUTION_PLAN.USE_INNGEST && !EXECUTION_PLAN.FALLBACK_MODE
}
```

## –ü–ª–∞–Ω –ê - Inngest (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- ‚úÖ –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥–∏
- ‚úÖ –ù–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry
- ‚úÖ Step-by-step –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å concurrency

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
1. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**
   - –°–æ–±—ã—Ç–∏–µ: `image/generate.start`
   - –§—É–Ω–∫—Ü–∏—è: `generateImageInngest`

2. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ**
   - Text-to-Video: `video/text-to-video.start`
   - Image-to-Video: `video/image-to-video.start`

3. **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—á–∏**
   - Text-to-Speech: `speech/text-to-speech.start`
   - Voice Avatar: `speech/voice-avatar.start`

4. **–û–±—É—á–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏**
   - –°–æ–±—ã—Ç–∏–µ: `model/training.start`
   - –§—É–Ω–∫—Ü–∏—è: `generateModelTraining`

### –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:

```typescript
// –í –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–µ
if (shouldUseInngest()) {
  await inngest.send({
    name: 'image/generate.start',
    data: {
      prompt,
      model_type: model,
      num_images,
      telegram_id,
      username,
      is_ru,
      bot_name,
    },
  })
}
```

## –ü–ª–∞–Ω –ë - Fallback

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
- ‚ö° –ë—ã—Å—Ç—Ä–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
- üîß –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞
- üöÄ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚ö†Ô∏è –ë–∞–∑–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ

### –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü–ª–∞–Ω –ë:
- Inngest –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
- –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Ç—É–∞—Ü–∏–∏
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
- –û—Ç–ª–∞–¥–∫–∞
- –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
1. `generateImageFallback`
2. `generateTextToVideoFallback` 
3. `generateImageToVideoFallback`
4. `generateSpeechFallback`
5. `createVoiceAvatarFallback`

## –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–ª–∞–Ω–∞–º–∏

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

–ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ—Ç –ø–ª–∞–Ω –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:

```typescript
if (shouldUseInngest()) {
  // –ü–ª–∞–Ω –ê - Inngest
  logger.info('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ê (Inngest)')
  await inngest.send(event)
} else {
  // –ü–ª–∞–Ω –ë - Fallback
  logger.info('–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ë (Fallback)')
  await fallbackFunction(params)
}
```

### –†—É—á–Ω–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ

```bash
# –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞ –ü–ª–∞–Ω –ë
export FALLBACK_MODE=true

# –û—Ç–∫–ª—é—á–∏—Ç—å Inngest –ø–æ–ª–Ω–æ—Å—Ç—å—é
export USE_INNGEST=false

# –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –ü–ª–∞–Ω—É –ê
export USE_INNGEST=true
export FALLBACK_MODE=false
```

## –°–æ–±—ã—Ç–∏—è Inngest

### –°—Ö–µ–º–∞ —Å–æ–±—ã—Ç–∏–π

```typescript
// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
interface ImageGenerationData {
  prompt: string
  model_type: string  
  num_images: number
  telegram_id: string
  username: string
  is_ru: boolean
  bot_name: string
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤–∏–¥–µ–æ
interface TextToVideoData {
  prompt: string
  videoModel: string
  telegram_id: string
  username: string
  is_ru: boolean
  bot_name: string
}

// –ò —Ç–∞–∫ –¥–∞–ª–µ–µ...
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –ø–ª–∞–Ω–æ–≤

```typescript
// –ü–ª–∞–Ω –ê
logger.info({
  message: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ê (Inngest)',
  telegram_id,
  eventType: 'image/generate.start'
})

// –ü–ª–∞–Ω –ë  
logger.info({
  message: '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –ë (Fallback)',
  telegram_id,
  function: 'generateImageFallback'
})
```

### –û—à–∏–±–∫–∏

```typescript
// –ü–ª–∞–Ω –ê - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ step functions
catch (error) {
  logger.error({
    message: '–û—à–∏–±–∫–∞ Inngest —Ñ—É–Ω–∫—Ü–∏–∏',
    error: error.message,
    step: 'generate-image'
  })
  throw error // Inngest –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç retry
}

// –ü–ª–∞–Ω –ë - –ø—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
catch (error) {
  logger.error('–û—à–∏–±–∫–∞ fallback —Ñ—É–Ω–∫—Ü–∏–∏:', error)
  await sendErrorNotification(telegram_id, error.message)
  throw error
}
```

## –î–µ–ø–ª–æ–π –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Inngest

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
export INNGEST_EVENT_KEY="your_event_key"
export INNGEST_SIGNING_KEY="your_signing_key"

# –ó–∞–ø—É—Å–∫ —Å Inngest
npm run dev
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–ª—å–∫–æ fallback

```bash  
# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ Inngest
export USE_INNGEST=false

# –ó–∞–ø—É—Å–∫ –±–µ–∑ Inngest
npm run dev
```

### 3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

```bash
# –¢–µ—Å—Ç –ø–ª–∞–Ω–∞ –ê
curl -X POST /api/generation/text-to-image \\
  -H "Content-Type: application/json" \\
  -d '{"prompt":"test","model":"flux","num_images":1,...}'

# –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –ø–ª–∞–Ω –ë  
export FALLBACK_MODE=true

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–π —Ç–µ—Å—Ç
curl -X POST /api/generation/text-to-image \\
  -H "Content-Type: application/json" \\
  -d '{"prompt":"test","model":"flux","num_images":1,...}'
```

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö Inngest
- [ ] –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–ª–∞–Ω–∞
- [ ] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retry –ø–æ–ª–∏—Ç–∏–∫
- [ ] –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ fallback —Ñ—É–Ω–∫—Ü–∏–∏
- [ ] A/B —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–æ–≤
- [ ] Dashboard –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ø–ª–∞–Ω–æ–≤

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–ù–æ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç:
1. **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å** - –≤—Å–µ–≥–¥–∞ –µ—Å—Ç—å –ø–ª–∞–Ω –ë
2. **–ì–∏–±–∫–æ—Å—Ç—å** - –ª–µ–≥–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É –ø–ª–∞–Ω–∞–º–∏  
3. **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å** - –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø–ª–∞–Ω–µ –ê
4. **–ü—Ä–æ—Å—Ç–æ—Ç—É** - –ø–æ–Ω—è—Ç–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ü–ª–∞–Ω –ê (Inngest) –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –∏ –ü–ª–∞–Ω –ë –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏/–æ—Ç–ª–∞–¥–∫–∏.