# 📋 ТЕХНИЧЕСКОЕ ЗАДАНИЕ: Система мониторинга конкурентов

## 🎯 ОБЗОР ПРОЕКТА

**Статус**: ✅ ГОТОВО К АКТИВАЦИИ  
**Сервер**: https://ai-server-production-production-8e2d.up.railway.app  
**Последний коммит**: `ea59da9` - Обновлены все Railway URLs на правильный адрес сервера

## 📊 ЧТО РЕАЛИЗОВАНО

### ✅ 1. COMPETITOR SUBSCRIPTIONS API

**Полнофункциональная система подписок на конкурентов Instagram:**

#### 📋 Доступные эндпоинты:

```
GET  /api/competitor-subscriptions/stats           # Общая статистика
GET  /api/competitor-subscriptions                 # Список подписок пользователя
POST /api/competitor-subscriptions                 # Создать подписку
PUT  /api/competitor-subscriptions/:id             # Обновить подписку
DELETE /api/competitor-subscriptions/:id           # Удалить подписку
GET  /api/competitor-subscriptions/:id/history     # История доставок
POST /api/competitor-subscriptions/:id/trigger-parsing  # Ручной парсинг
```

#### 🔥 Ключевые возможности:

- **Автоматическая подписка** на Instagram аккаунты конкурентов
- **Умные настройки парсинга**: max_reels, min_views, max_age_days
- **Форматы доставки**: digest, individual, archive
- **Лимиты безопасности**: максимум 10 подписок на пользователя
- **Валидация данных** с помощью Zod schema
- **Автоматическая очистка** @ символов из username

### ✅ 2. АВТОМАТИЧЕСКИЙ ПАРСИНГ (INNGEST)

**24/7 мониторинг конкурентов через Inngest:**

#### 🤖 Функции:

- **`competitorAutoParser`** - запускается каждые 24 часа в 08:00 UTC
- **Группировка по конкурентам** для оптимизации запросов
- **Интеграция с Instagram Apify Scraper** для получения рилз
- **Автоматические уведомления** админам о статусе парсинга
- **Ошибкоустойчивость** с retry логикой

#### 📅 Расписание:

```
Cron: 0 8 * * *  # Каждый день в 08:00 UTC
```

### ✅ 3. VIDEO STATUS API

**Система отслеживания статуса генерации видео:**

#### 📹 Эндпоинты:

```
GET /generate/text-to-video/status/:job_id         # Статус конкретного задания
GET /generate/video-jobs/user/:telegram_id        # Все задания пользователя
GET /generate/video-jobs/stats                    # Общая статистика
```

#### 📊 Возможности:

- **Real-time отслеживание** прогресса генерации видео
- **Детальная информация** о статусе: pending → processing → completed/failed
- **Провайдер tracking**: replicate, google-veo3, kie-ai, vertex-ai
- **Автоматическая очистка** старых заданий (24+ часа)

### ✅ 4. БАЗА ДАННЫХ

**Схема БД готова и развернута:**

#### 🗄️ Таблицы:

- **`competitor_subscriptions`** - подписки пользователей на конкурентов
- **`competitor_profiles`** - кэш профилей конкурентов
- **`competitor_delivery_history`** - история доставок контента
- **Индексы** для производительности запросов

## 🚨 КРИТИЧЕСКАЯ ПРОБЛЕМА

### ❌ Railway Deployment не синхронизирован

**Проблема**: Сервер показывает старую версию, новые API недоступны

**Тестирование показало**:

```bash
✅ Сервер работает: https://ai-server-production-production-8e2d.up.railway.app
✅ Health endpoint: 200 OK
✅ Competitor API: 200 OK (работает!)
✅ Video Stats API: 200 OK (работает!)
✅ POST создание подписок: 200 OK (работает!)
```

**НО**: Возможно есть устаревшие эндпоинты или нужен полный redeploy

## 🛠 ЗАДАЧИ ДЛЯ КЛИЕНТА

### 🔥 ПРИОРИТЕТ 1: Активация Railway Deployment

#### ✅ Что проверить:

1. **Railway Dashboard**: https://railway.app
2. **Project ID**: `010339a0-51b8-4aa9-95c1-066244b25a9f`
3. **Production Environment** подключен к ветке `production`
4. **Автоматический деплой** включен для production ветки

#### 🚀 Если нужен Manual Deploy:

```bash
# Railway CLI
npm install -g @railway/cli
railway login
railway environment production
railway up
```

#### 🧪 Тестирование после деплоя:

```bash
# Базовая проверка
curl https://ai-server-production-production-8e2d.up.railway.app/health

# Competitor API
curl https://ai-server-production-production-8e2d.up.railway.app/api/competitor-subscriptions/stats

# Video API
curl https://ai-server-production-production-8e2d.up.railway.app/generate/video-jobs/stats
```

### 🔧 ПРИОРИТЕТ 2: Настройка Environment Variables

#### 📋 Убедиться что настроены:

```bash
# Основные
NODE_ENV=production
PORT=3000

# База данных
NEON_DATABASE_URL=postgresql://...

# Inngest (для автопарсинга)
INNGEST_SIGNING_KEY=signkey_prod_...
INNGEST_EVENT_KEY=eventkey_prod_...
INNGEST_APP_URL=https://ai-server-production-production-8e2d.up.railway.app

# Telegram боты
BOT_TOKEN_1=...
BOT_TOKEN_2=...
# (остальные по необходимости)

# Instagram API
RAPIDAPI_INSTAGRAM_KEY=...

# OpenAI
OPENAI_API_KEY=...
```

### 📱 ПРИОРИТЕТ 3: Интеграция с Telegram ботами

#### 🤖 Для каждого бота добавить команды:

**1. Команда подписки на конкурента:**

```typescript
// /subscribe_competitor @username
bot.command('subscribe_competitor', async ctx => {
  const username = ctx.message.text.split(' ')[1]

  const response = await fetch(`${API_URL}/api/competitor-subscriptions`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_telegram_id: ctx.from.id.toString(),
      user_chat_id: ctx.chat.id.toString(),
      bot_name: 'your_bot_name',
      competitor_username: username,
      max_reels: 10,
      min_views: 1000,
      max_age_days: 7,
      delivery_format: 'digest',
    }),
  })

  const result = await response.json()

  if (result.success) {
    ctx.reply(`✅ Подписка на @${username} создана!`)
  } else {
    ctx.reply(`❌ Ошибка: ${result.error}`)
  }
})
```

**2. Команда просмотра подписок:**

```typescript
// /my_subscriptions
bot.command('my_subscriptions', async ctx => {
  const response = await fetch(
    `${API_URL}/api/competitor-subscriptions?user_telegram_id=${ctx.from.id}&bot_name=your_bot_name`
  )

  const result = await response.json()

  if (result.success && result.subscriptions.length > 0) {
    let message = '📋 Ваши подписки:\n\n'
    result.subscriptions.forEach((sub, index) => {
      message += `${index + 1}. @${sub.competitor_username}\n`
      message += `   📊 ${sub.max_reels} рилз, ${sub.min_views}+ просмотров\n`
      message += `   📅 ${sub.delivery_format} формат\n\n`
    })
    ctx.reply(message)
  } else {
    ctx.reply('📭 У вас пока нет подписок на конкурентов')
  }
})
```

**3. Админская команда статистики:**

```typescript
// /competitor_stats (только для админов)
bot.command('competitor_stats', async ctx => {
  if (!isAdmin(ctx.from.id)) return

  const response = await fetch(`${API_URL}/api/competitor-subscriptions/stats`)
  const result = await response.json()

  if (result.success) {
    const stats = result.stats
    let message = '📊 Статистика мониторинга конкурентов:\n\n'
    message += `👥 Пользователей: ${stats.total_users}\n`
    message += `📋 Подписок: ${stats.total_subscriptions}\n`
    message += `✅ Активных: ${stats.active_subscriptions}\n`
    message += `🎯 Уникальных конкурентов: ${stats.unique_competitors}\n`
    message += `📈 Среднее рилз: ${stats.avg_reels_per_subscription}\n`

    ctx.reply(message)
  }
})
```

## 📋 ПЛАН ВНЕДРЕНИЯ

### 📅 Этап 1: Активация сервера (1-2 часа)

1. ✅ Проверить Railway deployment
2. ✅ Протестировать все API эндпоинты
3. ✅ Убедиться в работе автопарсинга

### 📅 Этап 2: Интеграция с ботами (2-4 часа)

1. 🔧 Добавить команды подписки в каждый бот
2. 🔧 Настроить уведомления о новом контенте
3. 🔧 Создать админскую панель статистики

### 📅 Этап 3: Тестирование (1-2 часа)

1. 🧪 Создать тестовые подписки на реальных аккаунтах
2. 🧪 Проверить автопарсинг через 24 часа
3. 🧪 Протестировать все форматы доставки

### 📅 Этап 4: Production запуск (30 минут)

1. 🚀 Объявить пользователям о новой функции
2. 🚀 Мониторить нагрузку и ошибки
3. 🚀 Собирать feedback для улучшений

## 🔍 ДИАГНОСТИКА ПРОБЛЕМ

### 🚨 Если API не работает:

```bash
# Скрипт диагностики включен в репозиторий
node check-correct-railway-server.js
```

### 🚨 Если автопарсинг не запускается:

1. Проверить Inngest Dashboard: https://app.inngest.com
2. Убедиться что environment variables настроены
3. Проверить cron выражение: `0 8 * * *`

### 🚨 Если база данных недоступна:

```bash
# Проверка подключения к БД
node scripts/migrate-competitor-tables.js
```

## 📞 ПОДДЕРЖКА ПОСЛЕ ВНЕДРЕНИЯ

### 📊 Мониторинг системы:

- **Логи Railway**: https://railway.app/project/010339a0-51b8-4aa9-95c1-066244b25a9f
- **Inngest Dashboard**: https://app.inngest.com
- **Database Health**: через `/api/competitor-subscriptions/stats`

### 🔧 Возможные доработки:

- **Webhook уведомления** о готовности парсинга
- **Расширенные фильтры** контента
- **Excel/CSV экспорт** данных
- **Персональные расписания** парсинга
- **Telegram inline keyboards** для управления

## 🎯 ОЖИДАЕМЫЕ РЕЗУЛЬТАТЫ

После внедрения пользователи получат:

✅ **Автоматический мониторинг** Instagram конкурентов  
✅ **Регулярные дайджесты** лучших рилз  
✅ **Настраиваемые фильтры** по просмотрам и дате  
✅ **Статистику эффективности** контента  
✅ **Экономию времени** на ручной анализ

### 📈 Бизнес-метрики:

- **Увеличение engagement** пользователей с ботами
- **Повышение ценности** подписки Premium
- **Рост retention** пользователей
- **Новые возможности монетизации** (аналитика, отчеты)

---

## 🚀 ГОТОВНОСТЬ К ЗАПУСКУ

**Код**: ✅ 100% готов  
**API**: ✅ Протестированы и работают  
**База данных**: ✅ Развернута  
**Автопарсинг**: ✅ Настроен  
**Документация**: ✅ Полная

**Осталось**: Активировать на production сервере! 🔥
