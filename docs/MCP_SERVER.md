# MCP Server для AI-агентов

## Описание

MCP (Model Context Protocol) сервер предоставляет стандартизированный интерфейс для интеграции AI-агентов с нашими нейросервисами. Это позволяет использовать возможности ai-server прямо из редакторов кода, таких как Cursor, Windsurf и других MCP-совместимых приложений.

## Возможности

### Инструменты (Tools)

#### `create_neurophoto`
Создает нейрофото на основе текстового описания.

**Параметры:**
- `prompt` (string) - Описание для генерации изображения
- `gender` (enum: 'male' | 'female') - Пол для генерации
- `telegram_id` (string) - ID пользователя Telegram

**Пример использования:**
```json
{
  "name": "create_neurophoto",
  "arguments": {
    "prompt": "Профессиональный портрет в деловом костюме",
    "gender": "male",
    "telegram_id": "144022504"
  }
}
```

## Установка и Настройка

### 1. Сборка проекта
```bash
bun run build
```

### 2. Запуск MCP сервера
```bash
# Для разработки
bun run mcp:dev

# Для продакшена
bun run mcp:server
```

### 3. Настройка в Cursor

Добавьте следующую конфигурацию в настройки Cursor:

```json
{
  "mcp": {
    "servers": {
      "ai-server-neurophoto": {
        "command": "node",
        "args": ["dist/mcp/index.js"],
        "cwd": "/path/to/your/ai-server",
        "env": {
          "NODE_ENV": "development"
        }
      }
    }
  }
}
```

### 4. Настройка в других редакторах

Для других MCP-совместимых редакторов используйте аналогичную конфигурацию, адаптированную под их формат настроек.

## Архитектура

```
MCP Client (Cursor/Windsurf)
    ↓ JSON-RPC 2.0
MCP Server (ai-server-mcp)
    ↓ Internal API calls
Generation Controller
    ↓ External APIs
Replicate/OpenAI/etc.
```

## Безопасность

- Все запросы логируются для аудита
- Валидация входных параметров через Zod схемы
- Интеграция с существующей системой авторизации ai-server

## Разработка

### Добавление новых инструментов

1. Создайте новый файл в `src/mcp/tools/`
2. Определите Zod схему для параметров
3. Реализуйте логику инструмента
4. Зарегистрируйте инструмент в `src/mcp/server.ts`

### Пример нового инструмента

```typescript
// src/mcp/tools/example.ts
import { CallToolResult } from '@modelcontextprotocol/sdk/types.js';
import { z } from 'zod';

interface ExampleArgs {
  param1: string;
  param2: number;
}

export async function exampleTool(args: ExampleArgs): Promise<CallToolResult> {
  // Логика инструмента
  return {
    content: [
      {
        type: 'text',
        text: JSON.stringify({ result: 'success' }, null, 2),
      },
    ],
  };
}
```

## Тестирование

### Локальное тестирование
```bash
# Запуск сервера
bun run mcp:server

# В другом терминале - тестирование через MCP Inspector
npx @modelcontextprotocol/inspector
```

### Интеграционное тестирование
Используйте MCP Inspector для тестирования инструментов перед интеграцией с редакторами.

## Логирование

Все операции MCP сервера логируются через существующую систему логирования ai-server. Логи включают:

- Запуск/остановка сервера
- Вызовы инструментов
- Ошибки и исключения
- Результаты операций

## Мониторинг

- Логи доступны в стандартных файлах логов ai-server
- Метрики производительности отслеживаются через существующую систему мониторинга

## Troubleshooting

### Частые проблемы

1. **Сервер не запускается**
   - Проверьте, что проект собран: `bun run build`
   - Убедитесь, что все зависимости установлены: `bun install`

2. **Инструменты не работают**
   - Проверьте логи на наличие ошибок
   - Убедитесь, что ai-server запущен и доступен

3. **Редактор не видит сервер**
   - Проверьте правильность путей в конфигурации
   - Убедитесь, что MCP сервер запущен

## Roadmap

- [ ] Добавление инструментов для других нейросервисов
- [ ] Поддержка HTTP транспорта для удаленного доступа
- [ ] Расширенная система авторизации
- [ ] Кэширование результатов
- [ ] Метрики и аналитика использования 