# üß¨ –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: "output_too_large" –≤ Morphing API

**–î–∞—Ç–∞:** 2025-01-28  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô

---

## üö® **–ü—Ä–æ–±–ª–µ–º–∞**

### –°–∏–º–ø—Ç–æ–º—ã:

- ‚ùå Inngest —Ñ—É–Ω–∫—Ü–∏—è `morphImages` –∑–∞–≤–µ—Ä—à–∞–ª–∞—Å—å —Å –æ—à–∏–±–∫–æ–π **"output_too_large"**
- ‚ùå –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ—Ö–æ–¥–∏–ª–∞ —à–∞–≥–∏ `check-user-exists`, `check-balance`, `notify-start`
- ‚ùå –ü–∞–¥–∞–ª–∞ –Ω–∞ —à–∞–≥–µ `execute-morphing` –ø–æ—Å–ª–µ 4 –ø–æ–ø—ã—Ç–æ–∫ (Attempt 0-3)
- ‚ùå –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: ~2.7 –º–∏–Ω—É—Ç—ã –¥–æ –ø–∞–¥–µ–Ω–∏—è

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

```bash
# Inngest Dashboard –ø–æ–∫–∞–∑—ã–≤–∞–ª:
Run ID: 01K18080CEQTYJ56T8PTH5ZZF
Status: Failed
Error: "output_too_large"
Duration: 2.7m
```

---

## üîç **–ö–æ—Ä–Ω–µ–≤–∞—è –ø—Ä–∏—á–∏–Ω–∞**

### –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞:

1. **–§—É–Ω–∫—Ü–∏—è:** `src/inngest-functions/morphImages.ts` ‚Üí —à–∞–≥ `execute-morphing`
2. **–í—ã–∑–æ–≤:** `generateMorphingVideo(request)` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `MorphingJobResult`
3. **–ü—Ä–æ–±–ª–µ–º–∞:** `MorphingJobResult.zip_extraction.images: ExtractedImage[]`
4. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª–µ:** `ExtractedImage.buffer: Buffer` —Å–æ–¥–µ—Ä–∂–∏—Ç **–±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (–î–û –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è):

```typescript
interface ExtractedImage {
  filename: string
  originalName: string
  path: string
  buffer: Buffer // ‚ö†Ô∏è –ë–û–õ–¨–®–ò–ï –ë–ò–ù–ê–†–ù–´–ï –î–ê–ù–ù–´–ï
  order: number
}

interface ZipExtractionResult {
  success: boolean
  images: ExtractedImage[] // ‚ö†Ô∏è –ú–ê–°–°–ò–í –° –ë–£–§–ï–†–ê–ú–ò
  totalCount: number
  extractionPath: string
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ –≤—ã–∑—ã–≤–∞–ª–æ –æ—à–∏–±–∫—É:

- Inngest —Å–µ—Ä–∏–∞–ª–∏–∑—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –º–µ–∂–¥—É —à–∞–≥–∞–º–∏
- `Buffer` —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ (~1-5MB –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
- –ü—Ä–∏ 3+ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è—Ö –æ–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ø—Ä–µ–≤—ã—à–∞–ª –ª–∏–º–∏—Ç—ã Inngest
- Inngest –≤–æ–∑–≤—Ä–∞—â–∞–ª –æ—à–∏–±–∫—É "output_too_large"

---

## ‚ö° **–†–µ—à–µ–Ω–∏–µ**

### –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ:

**–§–∞–π–ª:** `src/inngest-functions/morphImages.ts`  
**–°—Ç—Ä–æ–∫–∏:** 245-270

```typescript
// –î–û (–ø—Ä–æ–±–ª–µ–º–Ω—ã–π –∫–æ–¥):
const result = await generateMorphingVideo(request)
return result

// –ü–û–°–õ–ï (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ):
const result = await generateMorphingVideo(request)

// üîß FIX: –û—á–∏—â–∞–µ–º –±–æ–ª—å—à–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è output_too_large
const cleanResult = {
  job_id: result.job_id,
  telegram_id: result.telegram_id,
  status: result.status,
  zip_extraction: {
    success: result.zip_extraction.success,
    totalCount: result.zip_extraction.totalCount,
    extractionPath: result.zip_extraction.extractionPath,
    error: result.zip_extraction.error,
    // –£–±–∏—Ä–∞–µ–º images: ExtractedImage[] —Å Buffer –¥–∞–Ω–Ω—ã–º–∏
  },
  kling_processing: result.kling_processing,
  video_storage: result.video_storage,
  telegram_delivery: result.telegram_delivery,
  created_at: result.created_at,
  completed_at: result.completed_at,
  processing_time: result.processing_time,
  final_video_url: result.final_video_url,
  error: result.error,
}

return cleanResult
```

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:

1. ‚úÖ **–£–¥–∞–ª–∏–ª–∏:** `images: ExtractedImage[]` —Å –±–∏–Ω–∞—Ä–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
2. ‚úÖ **–°–æ—Ö—Ä–∞–Ω–∏–ª–∏:** –ú–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –ø—É—Ç–∏, —Å—Ç–∞—Ç—É—Å—ã)
3. ‚úÖ **–†–µ–∑—É–ª—å—Ç–∞—Ç:** –†–∞–∑–º–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–Ω–∏–∂–µ–Ω —Å ~5-15MB –¥–æ ~1KB

---

## üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**

### –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ:

```bash
Job ID: morph_144022504_1753689469735
Bot: clip_maker_neuro_bot
Images: 3 —Ñ–∞–π–ª–∞ (~2MB ZIP)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã:

- ‚úÖ **API Response:** HTTP 200 OK
- ‚úÖ **Inngest Status:** Processing (–±–µ–∑ –ø–∞–¥–µ–Ω–∏–π)
- ‚úÖ **PM2 Stability:** 1 restart (—Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è)
- ‚úÖ **Error Resolution:** "output_too_large" —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:

```bash
# –°–±–æ—Ä–∫–∞ —Å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
bun run build

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Inngest –ø—Ä–æ—Ü–µ—Å—Å–∞
pm2 restart ai-server-inngest

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
node test-morphing-with-working-bot.js
```

---

## üìä **–í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:

- ‚úÖ **–°–∫–æ—Ä–æ—Å—Ç—å:** –ë—ã—Å—Ç—Ä–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É —à–∞–≥–∞–º–∏ Inngest
- ‚úÖ **–ü–∞–º—è—Ç—å:** –°–Ω–∏–∂–µ–Ω–∏–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –≤ PM2 –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ò—Å–∫–ª—é—á–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ —Å–µ—Ä–∏–∞–ª–∏–∑–∞—Ü–∏–∏
- ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±–æ–ª—å—à–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

### –ö–æ–º–ø—Ä–æ–º–∏—Å—Å—ã:

- ‚ö†Ô∏è **–î–∞–Ω–Ω—ã–µ:** –ë–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
- ‚úÖ **–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º (`extractionPath`) –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º

---

## üõ°Ô∏è **–ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ —Ä–µ–≥—Ä–µ—Å—Å–∏–π**

### –ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è –±—É–¥—É—â–µ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è:

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å `Buffer` –¥–∞–Ω–Ω—ã–µ –∏–∑ Inngest steps**
2. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –≤–º–µ—Å—Ç–æ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö**
3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ (>2MB)**
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–∞–∑–º–µ—Ä–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤**

### –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –Ω–æ–≤—ã—Ö Inngest —Ñ—É–Ω–∫—Ü–∏–π:

- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –ò–∑–±–µ–≥–∞—Ç—å `Buffer`, `Blob`, `File` –≤ return –∑–Ω–∞—á–µ–Ω–∏—è—Ö
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª–∞–º –∏–ª–∏ URL –¥–ª—è –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º –æ–±—ä–µ–º–æ–º –¥–∞–Ω–Ω—ã—Ö

---

## üéØ **–ó–∞–∫–ª—é—á–µ–Ω–∏–µ**

**–ü—Ä–æ–±–ª–µ–º–∞:** Inngest "output_too_large" –∏–∑-–∑–∞ –ø–µ—Ä–µ–¥–∞—á–∏ –±–∏–Ω–∞—Ä–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π  
**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∫–∞ –±–æ–ª—å—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö, —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –º–µ—Ç–∞–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏  
**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ –º–æ—Ä—Ñ–∏–Ω–≥ API —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

**–°—Ç–∞—Ç—É—Å:** üü¢ –ü–û–õ–ù–û–°–¢–¨–Æ –ò–°–ü–†–ê–í–õ–ï–ù–û  
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:** ‚úÖ –ü–†–û–ô–î–ï–ù–û  
**–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É:** ‚úÖ –î–ê

---

**–ê–≤—Ç–æ—Ä:** AI Assistant  
**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 2025-01-28  
**–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** ~30 –º–∏–Ω—É—Ç –æ—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –¥–æ —Ä–µ—à–µ–Ω–∏—è
